<!DOCTYPE html>
<html>
<head>
    <title>Advanced Whale Detector</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 20px; 
            background: #f8f9fa; 
        }
        .card { 
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .whale { 
            border-color: #ffd700; 
            background: #fff9e6; 
        }
        .details { 
            margin-top: 15px; 
            font-size: 0.9em; 
            color: #666; 
        }
        .candle-info { 
            margin-top: 10px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 4px; 
        }
        .nav-button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        .nav-button:hover {
            background-color: #0056b3;
        }
        .error-message {
            color: red;
            padding: 10px;
            margin: 10px 0;
            background: #fee;
            border-radius: 4px;
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1 style="color: #2c3e50; margin-bottom: 25px;">üêã Advanced Whale Detector</h1>
    <button class="nav-button" onclick="window.location.href='/profitable_pairs'">Go to Profitable Pairs</button>
    <div id="error-container" class="error-message"></div>
    <div id="loading" class="loading">Loading data...</div>
    <div id="dashboard"></div>

    <script>
        const dashboard = document.getElementById('dashboard');
        const errorContainer = document.getElementById('error-container');
        const loadingElement = document.getElementById('loading');
        
        function formatDate(timestamp) {
            return new Date(parseInt(timestamp)).toLocaleString();
        }

        function startEventSource() {
            const eventSource = new EventSource('/stream');
            
            eventSource.onmessage = e => {
                loadingElement.style.display = 'none';
                try {
                    const data = JSON.parse(e.data);
                    const card = document.createElement('div');
                    
                    card.className = `card ${data.whale_activity.has_whale_activity ? 'whale' : ''}`;
                    
                    let candlesHtml = '<div class="candle-info"><h3>Last 3 Candles:</h3>';
                    data.candles.forEach((candle, index) => {
                        candlesHtml += `
                            <div>Candle ${index + 1} (${formatDate(candle.timestamp)}):
                                Open: $${candle.open.toFixed(4)},
                                Close: $${candle.close.toFixed(4)}
                            </div>`;
                    });
                    candlesHtml += '</div>';

                    card.innerHTML = `
                        <div style="font-size: 1.2em; font-weight: bold;">${data.symbol} - $${data.price.toFixed(4)}</div>
                        <div class="details">
                            <div>Large Transactions: ${data.whale_activity.large_trades_count}</div>
                            <div>Small Transactions: ${data.whale_activity.small_trades_count}</div>
                            <div>Large Orders: ${data.whale_activity.large_orders_count}</div>
                        </div>
                        ${candlesHtml}
                    `;

                    dashboard.insertBefore(card, dashboard.firstChild);
                    if(dashboard.children.length > 20) dashboard.lastChild.remove();
                    
                    errorContainer.style.display = 'none';
                } catch (error) {
                    console.error('Error processing message:', error);
                    errorContainer.textContent = 'Error processing data. Retrying...';
                    errorContainer.style.display = 'block';
                }
            };

            eventSource.onerror = () => {
                errorContainer.textContent = 'Connection lost. Reconnecting...';
                errorContainer.style.display = 'block';
                eventSource.close();
                setTimeout(startEventSource, 5000);
            };
        }

        startEventSource();
    </script>
</body>
</html>